name: Integration Tests

on:
    push:
        branches: [main]
    pull_request:
        branches: [main]
    workflow_dispatch:

jobs:
    integration-test:
        runs-on: ubuntu-latest

        steps:
            - name: Checkout code
              uses: actions/checkout@v5

            - name: Set up Node.js
              uses: actions/setup-node@v6
              with:
                  node-version: 22

            - name: Install dependencies
              run: |
                  npm install -g @sap/cds-dk
                  npm install

            - name: Install bookshop dependencies
              run: |
                  cd __tests__/bookshop
                  npm install

            - name: Generate test certificates
              run: |
                  chmod +x scripts/generate-test-certs.sh
                  ./scripts/generate-test-certs.sh

            - name: Setup authentication configuration
              run: |
                  node scripts/setup-bookshop-auth.js

            - name: Load certificate environment variables
              run: |
                  if [ -f cert-env.txt ]; then
                      echo "Loading certificate environment variables..."
                      echo "=== Certificate Environment Variables ==="
                      cat cert-env.txt
                      echo "========================================="
                      grep -v '^#' cert-env.txt | grep -v '^$' >> $GITHUB_ENV
                  else
                      echo "cert-env.txt not found, skipping certificate environment variables"
                  fi

            - name: Load authentication environment variables
              run: |
                  if [ -f auth-env.txt ]; then
                      echo "Loading authentication environment variables..."
                      echo "=== Authentication Environment Variables ==="
                      cat auth-env.txt
                      echo "==========================================="
                      grep -v '^#' auth-env.txt | grep -v '^$' >> $GITHUB_ENV
                  else
                      echo "auth-env.txt not found, skipping authentication environment variables"
                  fi

            - name: Debug loaded environment variables
              run: |
                  echo "=== DEBUG: Loaded Environment Variables ==="
                  echo "ORD_AUTH_TYPE: ${ORD_AUTH_TYPE:-NOT_SET}"
                  echo "BASIC_AUTH_USERNAME: ${BASIC_AUTH_USERNAME:-NOT_SET}"
                  echo "BASIC_AUTH_HASH: ${BASIC_AUTH_HASH:0:20}..." # Show only first 20 chars of hash
                  echo "TRUSTED_ISSUER: ${TRUSTED_ISSUER:-NOT_SET}"
                  echo "TRUSTED_SUBJECT: ${TRUSTED_SUBJECT:-NOT_SET}"
                  echo "==========================================="

            - name: Build ORD documents for bookshop
              run: |
                  echo "=== DEBUG: Building ORD documents ==="
                  cds build __tests__/bookshop --for ord
                  echo "Build completed, checking generated files..."
                  ls -la __tests__/bookshop/gen/ord/ || echo "No ORD files generated"
                  echo "======================================="

            - name: Start bookshop application
              run: |
                  cd __tests__/bookshop
                  
                  echo "=== DEBUG: Starting CDS Server ==="
                  echo "Current directory: $(pwd)"
                  echo "Checking .cdsrc.json configuration:"
                  if [ -f .cdsrc.json ]; then
                      echo "=== .cdsrc.json content ==="
                      cat .cdsrc.json
                      echo "============================"
                  else
                      echo ".cdsrc.json not found!"
                  fi
                  
                  # Export environment variables to ensure they're available to CDS
                  export ORD_AUTH_TYPE="${ORD_AUTH_TYPE:-mtls,basic}"
                  export BASIC_AUTH_USERNAME="${BASIC_AUTH_USERNAME:-admin}"
                  export BASIC_AUTH_HASH="${BASIC_AUTH_HASH}"
                  export TRUSTED_ISSUER="${TRUSTED_ISSUER}"
                  export TRUSTED_SUBJECT="${TRUSTED_SUBJECT}"
                  
                  echo "Environment variables for CDS:"
                  echo "  ORD_AUTH_TYPE: $ORD_AUTH_TYPE"
                  echo "  BASIC_AUTH_USERNAME: $BASIC_AUTH_USERNAME"
                  echo "  BASIC_AUTH_HASH: ${BASIC_AUTH_HASH:0:20}..."
                  echo "  TRUSTED_ISSUER: $TRUSTED_ISSUER"
                  echo "  TRUSTED_SUBJECT: $TRUSTED_SUBJECT"
                  echo "  PORT: $PORT"
                  
                  echo "Starting CDS server with authentication: $ORD_AUTH_TYPE"
                  echo "Command: cds run"
                  cds run > ../bookshop.log 2>&1 &
                  CDS_PID=$!
                  echo "CDS PID: $CDS_PID"
                  
                  echo "Waiting 15 seconds for server startup..."
                  sleep 15
                  
                  echo "Checking if CDS process is still running..."
                  if ! kill -0 $CDS_PID 2>/dev/null; then
                      echo "ERROR: CDS process died, showing logs:"
                      echo "=== CDS Server Logs ==="
                      cat ../bookshop.log
                      echo "======================="
                      exit 1
                  fi
                  echo "CDS server started successfully (PID: $CDS_PID)"
                  echo "=================================="
              env:
                  PORT: 4004

            - name: Wait for application to be ready
              run: |
                  echo "=== DEBUG: Checking Application Readiness ==="
                  echo "Waiting for application to be ready..."
                  
                  for i in {1..30}; do
                      echo "Attempt $i/30: Testing connection to http://localhost:4004"
                      
                      # Test basic connectivity
                      if curl -s -o /dev/null -w "HTTP Status: %{http_code}" http://localhost:4004/ 2>/dev/null; then
                          echo " - Server is responding"
                      else
                          echo " - Server not responding yet"
                      fi
                      
                      # Test well-known endpoint
                      if curl -s http://localhost:4004/.well-known/open-resource-discovery > /dev/null 2>&1; then
                          echo "âœ“ Application is ready (well-known endpoint accessible)"
                          
                          # Show sample response for debugging
                          echo "=== Sample well-known response (without auth) ==="
                          curl -s http://localhost:4004/.well-known/open-resource-discovery | head -20
                          echo ""
                          echo "================================================="
                          break
                      fi
                      
                      if [ $i -eq 30 ]; then
                          echo "ERROR: Application not ready after 30 attempts"
                          echo "=== Final attempt details ==="
                          curl -v http://localhost:4004/.well-known/open-resource-discovery 2>&1 || echo "Curl failed"
                          echo "=== Latest server logs ==="
                          tail -50 __tests__/bookshop.log 2>/dev/null || echo "No logs available"
                          echo "=========================="
                          exit 1
                      fi
                      sleep 1
                  done
                  echo "============================================="

            - name: Run integration tests
              run: |
                  echo "=== DEBUG: Running Integration Tests ==="
                  
                  # Check test configuration
                  if [ ! -f test-config.json ]; then
                      echo "ERROR: Missing test-config.json"
                      exit 1
                  fi
                  
                  echo "Test configuration found:"
                  echo "=== test-config.json content ==="
                  cat test-config.json
                  echo "==============================="
                  
                  # Test different endpoints manually before running the test suite
                  echo ""
                  echo "=== Manual API Tests for Debugging ==="
                  
                  echo "1. Testing well-known endpoint without auth:"
                  curl -s -w "Status: %{http_code}\n" http://localhost:4004/.well-known/open-resource-discovery | head -10
                  
                  echo ""
                  echo "2. Testing with invalid basic auth:"
                  curl -s -w "Status: %{http_code}\n" -H "Authorization: Basic aW52YWxpZDppbnZhbGlk" http://localhost:4004/.well-known/open-resource-discovery | head -5
                  
                  echo ""
                  echo "3. Testing with valid basic auth:"
                  BASIC_AUTH=$(echo -n "${BASIC_AUTH_USERNAME:-admin}:${TEST_PASSWORD:-test-secret-123}" | base64)
                  curl -s -w "Status: %{http_code}\n" -H "Authorization: Basic $BASIC_AUTH" http://localhost:4004/.well-known/open-resource-discovery | head -10
                  
                  echo ""
                  echo "4. Testing with mTLS headers:"
                  curl -s -w "Status: %{http_code}\n" \
                    -H "x-ssl-client-verify: 0" \
                    -H "x-ssl-client-subject-dn: ${TRUSTED_SUBJECT:-C=DE,O=SAP,OU=UCL,CN=ucl-discovery-bot}" \
                    -H "x-ssl-client-issuer-dn: ${TRUSTED_ISSUER:-C=DE,O=SAP,OU=UCL,CN=UCL Certificate Authority}" \
                    http://localhost:4004/.well-known/open-resource-discovery | head -10
                  
                  echo ""
                  echo "======================================"
                  echo ""
                  
                  # Show current server logs before running tests  
                  echo "=== Current Server Logs (last 20 lines) ==="
                  tail -20 __tests__/bookshop.log 2>/dev/null || echo "No logs available"
                  echo "==========================================="
                  echo ""
                  
                  # Run the actual test suite
                  echo "Starting integration test suite..."
                  node __tests__/bookshop/test-mtls-integration.js
              env:
                  BASE_URL: http://localhost:4004

            - name: Capture server logs after integration tests
              run: |
                  echo "=== DEBUG: Server Logs After Integration Tests ==="
                  if [ -f __tests__/bookshop.log ]; then
                      echo "Server log file size: $(wc -l < __tests__/bookshop.log) lines"
                      echo "=== Last 50 lines of server logs ==="
                      tail -50 __tests__/bookshop.log
                      echo "===================================="
                  else
                      echo "No server log file found"
                  fi
              if: always()

            - name: Run unit tests
              run: |
                  npm test

            - name: Upload test artifacts
              uses: actions/upload-artifact@v4
              if: always()
              with:
                  name: test-artifacts
                  path: |
                      test-config.json
                      test-headers.json
                      cert-env.txt
                      auth-env.txt
                      __tests__/bookshop.log
                  retention-days: 7
